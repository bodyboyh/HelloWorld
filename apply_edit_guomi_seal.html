<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta charset="UTF-8">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache">
<META HTTP-EQUIV="Cache-Control" CONTENT="no-cache">
<META HTTP-EQUIV="Expires" CONTENT="0">

<title>印模申请</title>
<link rel="stylesheet"
	href="../../shared/bootstrap/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="../../shared/css/index-ess.css"
	type="text/css" />
<link rel="stylesheet" href="../../shared/css/font-awesome.min.css"
	type="text/css" />
<link rel="stylesheet" href="../../shared/css/document.css"
	type="text/css" />
	<link rel="stylesheet" href="../../shared/bootstrap/css/bootstrap.css"
	type="text/css" />
<link rel="stylesheet" href="../../shared/css/dj-bootstrap.css"
	type="text/css" />
<link rel="stylesheet" href="../../shared/css/dj-tab.css"
	type="text/css" />
<link rel="stylesheet" href="../../shared/css/main.css" type="text/css" />

<!-- jqgrid样式 -->
<link href="../../shared/jqgrid/css/ui.jqgrid.css" type="text/css"
	rel="stylesheet" />
<link
	href="../../shared/jqgrid/css/css/flick/jquery-ui-1.8.16.custom.css"
	type="text/css" rel="stylesheet" />

<!--javascript引用部分 -->
<script src="../../shared/js/jquery-1.8.3.min.js" type="text/javascript"></script>
<script src="../../shared/js/jquery.extend.js" type="text/javascript"></script>
<script src="../../shared/js/myLayer.js" type="text/javascript"></script>
<script src="../../shared/ztree/js/jquery.ztree.core.min.js"
	type="text/javascript"></script>

<!-- jqgridjs -->
<script src="../../shared/jqgrid/js/jquery.jqGrid.src.js"
	type="text/javascript"></script>
<script src="../../shared/jqgrid/js/jquery.jqGrid.extend.js"
	type="text/javascript"></script>
<script type="text/javascript"
	src="../../shared/jqgrid/js/i18n/grid.locale-cn.js"></script>

<script src="../../shared/bootstrap/js/bootstrap.min.js"
	type="text/javascript"></script>
<script src="../../shared/layer/layer.js" type="text/javascript"></script>

<!-- my97 DatePicker  -->
<script src="../../shared/my97/WdatePicker.js" type="text/javascript"></script>

<script src="../../shared/plugins/utils.js" type="text/javascript"></script>
	<script src="../../shared/js/json2.js" type="text/javascript"></script>
	<script src="../../shared/js/jquery.placeholder.js" type="text/javascript"></script>

	<style type="text/css">
  #myForm>div{
  	margin-bottom:15px;
  }
</style>
</head>
<body>
			<div style="margin-left:40px">
				<form name="myForm" id="myForm" role="form" class="form-horizontal margin-top-2">
					<div class=" ">
						<label class="col-md-2 margin-left-2 margin-right-2 control-label ">印模名称</label>
						<div class="col-md-6 ">
							<input type="text" name="name" id="name" placeholder="请输入名称"><span class="msg margin-left-2" id="nameMsg"></span>
							<input type="hidden" id="sealId" name="sealId">
						</div>
					</div>
					<div >
						<label class="col-md-2 margin-left-2 margin-right-2 control-label">所属部门</label>
						<div class="col-md-4 ng-scope">
							<input type="text" name="departmentName" id="departmentName" placeholder="请点击按钮选择" readonly="readonly">
							<input type="hidden" name="departmentId" id="departmentId">
							<input type="button" value="选择" class="btn btn-primary col-padding-2" onclick="selectDeapartment()">
						</div>
							
					</div>
					<div>
						<label
							class="col-md-2 margin-left-2 margin-right-2 control-label ">印模类型</label>
						<div class="col-md-6">
							<select class="form-control" id="type">
								<option value="" class="" selected="selected">请选择...</option>
								<option label="公章" value="1">公章</option>
								<option label="公章(法人章)" value="2">公章(法人章)</option>
								<option label="公章(合同章)" value="3">公章(合同章)</option>
								<option label="公章(党章)" value="4">公章(党章)</option>
								<option label="公章(财务章)" value="5">公章(财务章)</option>
								<option label="公章(工会章)" value="6">公章(工会章)</option>
								<option label="个人章" value="7">个人章</option>
								<option label="个人章(手写签名)" value="8">个人章(手写签名)</option>
								<option label="个人章(文字签名)" value="9">个人章(文字签名)</option></select>
						</div>
					</div>

					<div id="imageView" style="display:none">
						<label class="col-md-2 margin-left-2 margin-right-2 control-label">已选图片</label>
						<div class="col-md-6" style="width: 150px;height: 150px;margin-left: 150px">
							<div id="imgPre"></div>
							<input type="hidden" id="data" name="data">
							<input type="hidden" id="gmzImageName" name="gmzImageName">
						</div>
					</div>
					<div class=" ">
						<label class="col-md-2 margin-left-2 margin-right-2 control-label">选择图片</label>
						<input type="file" id="selectImage" accept=".jpg,.jpeg,.bmp" >
					</div>
					<div class=" ">
						<label class="col-md-2 margin-left-2  margin-right-2 control-label">文件格式</label>
						<div class="col-md-8">
							<p class="form-control-static" style="padding-top: 5px">支持jpg,jpeg,bmp图片格式。最大尺寸:800*800</p>
						</div>
					</div>
					<div class=" ">
						<label class="col-md-2 margin-left-2  margin-right-2 control-label" >宽度(px)</label>
						<div class="col-md-6">
							<input type="text" name="sealWidth" id="sealWidth" class="form-control" readonly="readonly">
						</div>
					</div>
					<div class=" ">
						<label class="col-md-2 margin-left-2  margin-right-2 control-label" >高度(px)</label>
						<div class="col-md-6">
							<input type="text" name="sealHeight" id="sealHeight" class="form-control" readonly="readonly">
						</div>
					</div>
					<div class=" ">
						<label class="col-md-2 margin-left-2  margin-right-2 control-label" >印章DPI</label>
						<div class="col-md-6">
							<input type="text" class="form-control" id="sealSize" readonly="readonly" value="192">
						</div>
					</div>
					<div class=" ">
						<label class="col-md-2 margin-left-2 margin-right-2  control-label" >制章大小</label>
						<div class="col-md-6">
							<input type="text" class="form-control" id="makeSealSizeStr" readonly="readonly">
						</div>
					</div>
					<div class="has-feedback form-group" >
						<label class="margin-left-2 margin-right-2 control-label">用章人</label>
						<div class="col-md-4">
							<input type="text" name="userName" id="userName" class="form-control" readonly="readonly" placeholder="请点击按钮选择">
							<input type="button" value="选择" class="btn btn-primary col-padding-2" onclick="selectPeople()">
						</div>
					</div>
					<div class="has-feedback form-group">
						<label class=" margin-left-2 margin-right-2 control-label">制章证书</label>
						<div class="col-md-6">
							<select class="form_input" id="makeCerts" name="makeCerts">
								<option value="">请选择...</option>
							</select>
						</div>
					</div>
					<div>
						<label class="col-md-2 margin-left-2 margin-right-2 control-label">有效期开始</label>
                        <div class="col-md-6">
                            <input id="beginTime" name="beginTime" type="text" data-toggle="dropdown" readonly="readonly"
                                   class="form-control"
                                   placeholder="有效期开始时间" onfocus="WdatePicker({skin:'whyGreen',readOnly:true,dateFmt: 'yyyy-MM-dd HH:mm:ss', minDate:'#F{$dp.$D(\'endTime\') }'}) ">
                        </div>
					</div>
					<div>
						<label class="col-md-2 margin-left-2 margin-right-2 control-label">有效期结束</label>
                        <div class="col-md-6">
                            <input id="endTime" name="endTime" type="text" data-toggle="dropdown" readonly="readonly"
                                   class="form-control"
                                   placeholder="有效期结束时间" onfocus="WdatePicker({skin:'whyGreen',readOnly:true,dateFmt: 'yyyy-MM-dd HH:mm:ss', minDate:'#F{$dp.$D(\'beginTime\') }'}) ">
                        </div>
					</div>
					<div class=" ">
						<label class="col-md-2 margin-left-2 margin-right-2 control-label">申请原因</label>
						<div class="col-md-6">
							<textarea class="form-control" id="remark" placeholder="请输入申请原因" style="resize: none"></textarea>
						</div>
					</div>
					<div>
						<label class="col-md-2 margin-left-2 margin-right-2 control-label">审批文件</label>
						<div class="col-md-4 ng-scope">
						    <input type="file" class="form-control" name="fileSrc" id="fileSrc" accept=".pdf,.ofd"/>
							<p class="form-control-static" style="padding-top: 5px" id="fileNames"></p>
							<ul id='file-list-display'></ul>
						</div>
					</div>
					<div>
						<label class="col-md-2 margin-left-2  margin-right-2 control-label">文件格式</label>
						<div class="col-md-8">
							<p class="form-control-static" style="padding-top: 5px">支持pfd,ofd文件。最多上传3个</p>
						</div>
					</div>
				</form>
			</div>
</body>
<script type="text/javascript">
	$("input").placeholder();
	//加载jqGrid
	var msObj;
	var urlPath=getUrlPath();
	// 用章人
	var userCerts=[];
	var signData=[];
	var approvalFiles=[];
    var fileListDisplay = document.getElementById('file-list-display');
	$(document).ready(function() {
		queryCerts();
	});

	function getData(){
		var idArr=new Array();
		var formData = getFormData("myForm");
		var data={};

		data["approvalFiles"]=approvalFiles;
        data['beginTime']=0;
        data['departmentId']=null;
        data['endTime']=0;
        data['makeCerts']=null;
        data['name']=null;
        data['sealHeight']=0;
		data['sealImageId']='GMZ';
        data['sealWidth']=0;
        data['type']=0;
        data['userCerts']=[];
		data['gmzImageName']=null;
		data['data']=null;
		data['remark']=null;

		if(formData.name!=""){
			data['name']=formData.name;
		}else{
			msg("请输入印章名称！");
			return;
		}
		if(formData.departmentId!=""){
			   data['departmentId']=formData.departmentId;
		 }else{
			 msg("请选择部门！");
			 return;
		 }
		if(formData.type!=""){
			   data['type']=formData.type;
		 }else{
			 msg("请选择类型！");
			 return;
		 }
		if(formData.userId!=""){
			data['userCerts']=userCerts;
		}else{
			msg("请选择用章人！");
			return;
		}
		if(formData.makeCerts!=""){
			data['makeCerts']=formData.makeCerts;
			signData.push(formData.makeCerts);
		}else{
			msg("请选择制章人证书！");
			return;
		}
		if(formData.beginTime!=""){
			data['beginTime']=new Date(Date.parse(formData.beginTime.replace(/-/g,"/"))).getTime()/1000;
		}else{
			msg("请选择有效开始时间！");
			return;
		}
		if(formData.endTime!=""){
			data['endTime']=new Date(Date.parse(formData.endTime.replace(/-/g,"/"))).getTime()/1000 + nextDayTime;
		}else{
			msg("请选择有效开始时间！");
			return;
		}

		if(formData.data!=""){
			data['gmzImageName']=formData.gmzImageName;
			data['data']=formData.data;
			data['remark']=formData.remark;
			data['sealHeight']=formData.sealHeight;
			data['sealWidth']=formData.sealWidth;
		}else{
			 msg("请选择印章图片！");
			 return;
		 }
		idArr.push(data);
		var result = "no";
		$.ajax({
			type : "POST",
			url : urlPath+"/seal_localsign",
			data : JSON.stringify(idArr),
			contentType:"application/json",
			dataType : "json",
			async:false,
			success : function(data) {
				if(data){
					$.ajax({
						type: "POST",
						url: urlPath + '/save_seal_localsign',
						data:JSON.stringify(signData),
						contentType: "application/json",
						dataType: "json",
						async:false,
						success: function (data) {
							result = "yes";
						},
						error : function(xmlhttp,textStatus,errorThrown){
							var o = JSON.parse(xmlhttp.responseText);
							layer.msg(o.message, {icon: 5});
						}
					});
				}
			},
			error : function(xmlhttp,textStatus,errorThrown){
				var o = JSON.parse(xmlhttp.responseText);
				top.layer.msg(o.message, {icon: 5});
			}
		});
		return result;
	}
	$("#name").change(function(){
		var name=$("#name").val();
		if(name==""){
			$("#nameMsg").html('<b style="color:red">输入不能为空</b>');
		}else{
			$.ajax({
				type : "GET",
				url : urlPath+"/seal",
				data:{
					sealName:name
				},
				dataType : "JSON",
				success : function(retdata) {
					if(retdata){
						$("#nameMsg").html("");
						$("#nameMsg").append('<span class="fa fa-check text-success-dark" aria-hidden="true"></span>');
					}
				},
				error:function (e) {
	                var res = $.parseJSON(e.responseText);
	                //console.log(res);
	                $("#nameMsg").html('<b style="color:red">'+res.message+'</b>');
			    }
			});	
		}
	});
	function makeSeal(){
		$("#imageView").show();
	}
	 function closeMakeSeal(){
		$("#sealWidth").val(null);
		$("#sealHeight").val(null);
		$("#sealSize").val(null);
		$("#makeSealSizeStr").val(null);
		$("#imgPre").attr("src",'');
		$("#imageView").hide();
		$("#myModal").modal('hide'); 
	} 
	 function selectDeapartment(){
			var index =top.layer.open({
				title:'选择部门',
				type: 2,
				content: '../../partials/select-section-nolow.html',
				area: ['800px', '500px'],
				btn: ['确定','关闭'],
				maxmin: true,
	            yes: function(index){
	            	//获取单位数据 
	            	var res = window.parent["layui-layer-iframe" + index].getData();
	            	 if(res==null){
	            		 window.parent.layer.alert("请选择部门",{icon:6});
	            	 }else{
	            		 $("#departmentName").val(res.name);
	            		 $("#departmentId").val(res.id);
	            		 top.layer.close(index);	 
	            	 }
	            }
			});
		}

	function queryCerts() {
		$.ajax({
			type : "GET",
			url : urlPath + "/all_certs?noCache=" + new Date().getTime(),
			contentType : "application/json",
			dataType : "json",
			success : function(data) {
				for (var i = 0; i < data.length; i++) {
					$("#makeCerts").append(
							"<option value="+data[i].id+">" + data[i].name
							+ "</option>");
				}
			},
			error: function (xmlhttp, textStatus, errorThrown) {
				var o = JSON.parse(xmlhttp.responseText);
				layer.msg(o.message, {icon: 5});
			}
		});
	}

	function selectPeople(){
		var index = window.parent.layer.open({
			title:'选择人员',
			type: 2,
			content: '../seal/select-accredit-people-modal.html?sealId=GMZ',
			area: ['800px', '500px'],
			btn: ['确定','关闭'],
			maxmin: true,
			yes: function(index){
				//获取单位数据
				var res = window.parent["layui-layer-iframe" + index].getData();
				var userName="";
				if(res != null){
					if(res.length > 0){
						for(var i = 0; i < res.length;i++){
							userCerts[i] = res[i].id;
							userName+=res[i].name+",";
						}
					}else{
						userCerts[0] = null;
					}
					$("#userName").val(userName);
					window.parent.layer.close(index);
				}else{
					window.parent.layer.alert("请选择人员",{icon:6});
				}
			}
		});
	}
	$(function() {
		$("#fileSrc").change(function(e) {
			if(approvalFiles.length>=3){
				layer.msg("最多选3个审批文件", {icon: 5});
				return;
			}
			var tag = e.target;
			var fileName="";
            //approvalFiles=[];
			for(var i=0;i<tag.files.length;i++){
                var fileJson={};
                var file = tag.files[i];
                // 获取上传图片名
                fileJson["name"]=file.name;
                fileName+=fileJson["name"]+",";
				var fileSrc;
				var reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = function() {
					// 获取上传文件base64
					fileSrc = this.result;
					fileJson["data"]=fileSrc.substr(fileSrc.lastIndexOf("base64,")+7);
				};
                var fileDisplayEl = document.createElement("li");
                fileDisplayEl.setAttribute("style","margin-left:100px");//可行
                var deleteHtml = "<span style='margin-left: 100px' class='fa fa-trash' onclick='deleteFileFn("+approvalFiles.length+")' title='删除'></span>";
                fileDisplayEl.innerHTML ="      "+file.name +deleteHtml;
                fileListDisplay.appendChild(fileDisplayEl);
                approvalFiles.push(fileJson);
            }
			$("#fileNames").val(fileName);
		});
	})
    function deleteFileFn(index) {
        //页面中移除删掉的元素
        var ul = document.querySelector("#file-list-display");
        var lis = ul.querySelectorAll("li");
        lis[index].remove();

		//从数组中移除删掉文件
		approvalFiles.splice(index,1);
    }


    $(function() {
        $("#selectImage").change(function(e) {
            var imgBox = e.target;
            uploadImg($('#imgPre'), imgBox)
        });

        function uploadImg(element, tag) {
            var file = tag.files[0];
            if (!/image\/\w+/.test(file.type)) {
                alert("请确保文件为图像类型");
                return false;
            }
            // 设置预览区域为空,预览区域显示
            $('#imgPre').empty();
            $("#imageView").show();

            // 获取上传图片名
            $("#gmzImageName").val(file.name);

            var imgSrc;
            var reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(e) {
                imgSrc = this.result;
                //获取上传图片base64
                $("#data").val(imgSrc.substr(imgSrc.lastIndexOf("base64,")+7));
                var imgs = document.createElement("img");
                $(imgs).attr("src", imgSrc);
                element.append(imgs);
				$('#imgPre').get(0).src = e.target.result;
                /* 获取高宽*/
                var image = new Image();
                image.src = e.target.result;
                image.onload = function () {
                    /*var makeSealSizeStr='宽：'+this.width+'mm;'+'高：'+this.height+'mm';
                    $("#sealWidth").val(this.width);
                    $("#sealHeight").val(this.height);
                    $("#makeSealSizeStr").val(makeSealSizeStr);*/
                    var  width1= Math.floor(this.width/192*25.4);
                    var  height1= Math.floor(this.height/192*25.4);
                    var makeSealSizeStr='宽：'+width1+'mm;'+'高：'+height1+'mm';
                    $("#sealWidth").val(width1);
                    $("#sealHeight").val(height1);
                    $("#makeSealSizeStr").val(makeSealSizeStr);
                };
            };
        }
    })
</script>
</html>