<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta charset="UTF-8">
	<META HTTP-EQUIV="Pragma" CONTENT="no-cache">
	<META HTTP-EQUIV="Cache-Control" CONTENT="no-cache">
	<META HTTP-EQUIV="Expires" CONTENT="0">

	<title>印模申请</title>
	<link rel="stylesheet"
		  href="../../shared/bootstrap/css/bootstrap.min.css" type="text/css" />
	<link rel="stylesheet" href="../../shared/css/index-ess.css"
		  type="text/css" />
	<link rel="stylesheet" href="../../shared/css/font-awesome.min.css"
		  type="text/css" />
	<link rel="stylesheet" href="../../shared/css/document.css"
		  type="text/css" />
	<link rel="stylesheet" href="../../shared/bootstrap/css/bootstrap.css"
		  type="text/css" />
	<link rel="stylesheet" href="../../shared/css/dj-bootstrap.css"
		  type="text/css" />
	<link rel="stylesheet" href="../../shared/css/dj-tab.css"
		  type="text/css" />
	<link rel="stylesheet" href="../../shared/css/main.css" type="text/css" />

	<!-- jqgrid样式 -->
	<link href="../../shared/jqgrid/css/ui.jqgrid.css" type="text/css"
		  rel="stylesheet" />
	<link
			href="../../shared/jqgrid/css/css/flick/jquery-ui-1.8.16.custom.css"
			type="text/css" rel="stylesheet" />

	<!--javascript引用部分 -->
	<script src="../../shared/js/jquery-1.8.3.min.js" type="text/javascript"></script>
	<script src="../../shared/js/jquery.extend.js" type="text/javascript"></script>
	<script src="../../shared/js/myLayer.js" type="text/javascript"></script>
	<script src="../../shared/ztree/js/jquery.ztree.core.min.js"
			type="text/javascript"></script>

	<!-- jqgridjs -->
	<script src="../../shared/jqgrid/js/jquery.jqGrid.src.js"
			type="text/javascript"></script>
	<script src="../../shared/jqgrid/js/jquery.jqGrid.extend.js"
			type="text/javascript"></script>
	<script type="text/javascript"
			src="../../shared/jqgrid/js/i18n/grid.locale-cn.js"></script>

	<script src="../../shared/bootstrap/js/bootstrap.min.js"
			type="text/javascript"></script>
	<script src="../../shared/layer/layer.js" type="text/javascript"></script>

	<!-- my97 DatePicker  -->
	<script src="../../shared/my97/WdatePicker.js" type="text/javascript"></script>

	<script src="../../shared/plugins/utils.js" type="text/javascript"></script>
	<script src="../../shared/js/json2.js" type="text/javascript"></script>
	<style type="text/css">
		#myForm>div{
			margin-bottom:15px;
		}
	</style>
</head>
<body>

<div style="margin-left:40px">
	<form name="myForm" id="myForm" role="form" class="form-horizontal margin-top-2">
		<div class=" ">
			<label class="col-md-2 margin-left-2 margin-right-2 control-label ">印模名称</label>
			<div class="col-md-6 ">
				<input type="text" name="name" id="name" placeholder="请输入名称"><span class="msg margin-left-2" id="nameMsg"></span>
				<input type="hidden" id="sealId" name="sealId">
			</div>
		</div>
		<div >
			<label class="col-md-2 margin-left-2 margin-right-2 control-label">所属部门</label>
			<div class="col-md-4 ng-scope">
				<input type="text" name="departmentName" id="departmentName" placeholder="请点击按钮选择" readonly="readonly">
				<input type="hidden" name="departmentId" id="departmentId">
				<input type="button" value="选择" class="btn btn-primary col-padding-2" onclick="selectDeapartment()">
			</div>

		</div>
		<div>
			<label
					class="col-md-2 margin-left-2 margin-right-2 control-label ">印模类型</label>
			<div class="col-md-6">
				<select class="form-control" id="type">
					<option value="" class="" selected="selected">请选择...</option>
					<option label="公章" value="1">公章</option>
					<option label="公章(法人章)" value="2">公章(法人章)</option>
					<option label="公章(合同章)" value="3">公章(合同章)</option>
					<option label="公章(党章)" value="4">公章(党章)</option>
					<option label="公章(财务章)" value="5">公章(财务章)</option>
					<option label="公章(工会章)" value="6">公章(工会章)</option>
					<option label="个人章" value="7">个人章</option>
					<option label="个人章(手写签名)" value="8">个人章(手写签名)</option>
					<option label="个人章(文字签名)" value="9">个人章(文字签名)</option></select>
			</div>
		</div>

		<div id="imageView" style="display:none">
			<label class="col-md-2 margin-left-2 margin-right-2 control-label">已选图片</label>
			<div class="col-md-6" style="width: 150px;height: 150px;margin-left: 150px">
				<img id="imgPre"/>
				<input type="hidden" id="data" name="data">
				<input type="hidden" id="imageName" name="imageName">
			</div>
		</div>
		<div class=" ">
			<label class="col-md-2 margin-left-2 margin-right-2 control-label">选择图片</label>
			<input type="file" id="selectImage" accept=".jpg,.jpeg,.bmp" >
		</div>
		<div class=" ">
			<label class="col-md-2 margin-left-2  margin-right-2 control-label">文件格式</label>
			<div class="col-md-8">
				<p class="form-control-static" style="padding-top: 5px">支持jpg,jpeg,bmp图片格式。最大尺寸:800*800</p>
			</div>
		</div>
		<div class=" ">
			<label class="col-md-2 margin-left-2  margin-right-2 control-label" >宽度(px)</label>
			<div class="col-md-6">
				<input type="text" name="imageWidth" id="imageWidth" class="form-control" readonly="readonly">
			</div>
		</div>
		<div class=" ">
			<label class="col-md-2 margin-left-2  margin-right-2 control-label" >高度(px)</label>
			<div class="col-md-6">
				<input type="text" name="imageHeight" id="imageHeight" class="form-control" readonly="readonly">
			</div>
		</div>
		<div class=" ">
			<label class="col-md-2 margin-left-2  margin-right-2 control-label" >印章DPI</label>
			<div class="col-md-6">
				<input type="text"
					   class="form-control" id="sealSize" value="192">
			</div>
		</div>
		<div class=" ">
			<label class="col-md-2 margin-left-2 margin-right-2  control-label" >制章大小</label>
			<div class="col-md-6">
				<input type="text" class="form-control" id="makeSealSizeStr" readonly="readonly">
			</div>
		</div>
		<div class=" " id="approval">
			<label class="col-md-2 margin-left-2 margin-right-2 control-label">审批人</label>
			<div class="col-md-4">
				<input type="hidden" name="approvalBy" id="approvalBy">
				<input type="text" name="approvalByName" id="approvalByName" class="form-control" readonly="readonly" placeholder="请点击按钮选择">
				<input type="button" value="选择" class="btn btn-primary col-padding-2" onclick="selectPeople()">
			</div>
		</div>
		<div class=" ">
			<label class="col-md-2 margin-left-2 margin-right-2 control-label" id = "remarkId">备注</label>
			<div class="col-md-6">
				<textarea class="form-control" id="remark" placeholder="请输入备注" style="resize: none"></textarea>
			</div>
		</div>
	</form>
</div>
</body>
<script type="text/javascript">
	//加载jqGrid
	var urlPath=getUrlPath();

	var _optFlag = GetQueryString("optFlag");

	$(document).ready(function() {
		if(_optFlag=='modify'){
			var _sealId=GetQueryString("sealId");
			sealFormInit(_sealId);
		}
		if(_optFlag == "offlineApply"){//审批人线下申请
			offlinePage();
		}
	});

	function GetQueryString(name){
		var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
		var r = window.location.search.substr(1).match(reg);
		if(r!=null)return  decodeURI(r[2]); return null;
	}

	function getData(){
		var idArr=new Array();
		var formData = getFormData("myForm");
		var data={};
		data['name']=null;
		data['departmentId'] = null;
		data['type']=0;
		data["approvalBy"] = null;
		data['data']=null;
		data['sealSize'] = 192;
		data['remark'] = null;
		data['imageWidth'] = 0;
		data['imageHeight'] = 0;
		data['imageName'] = null;

		if(formData.name!=""){
			data['name']=formData.name;
		}else{
			msg("请输入印模名称！");
			return;
		}
		if(formData.departmentId!=""){
			data['departmentId']=formData.departmentId;
		}else{
			msg("请选择部门！");
			return;
		}
		if(formData.type!=""){
			data['type']=formData.type;
		}else{
			msg("请选择类型！");
			return;
		}
		if(formData.approvalBy!=""){
			data['approvalBy']=formData.approvalBy;
		}else{
			if(_optFlag!="offlineApply"){
				msg("请选择审批人！");
				return;
			}
		}
		if(formData.data!=""){
			data['data']=formData.data;
			data['sealSize']=formData.sealSize;
			data['remark']=formData.remark;
			data['imageWidth']=formData.imageWidth;
			data['imageHeight']=formData.imageHeight;
			data['imageName']=formData.imageName;
		}else{
			msg("请选择印章图片！");
			return;
		}
		if(_optFlag=="modify"){
			data['id']=formData.sealId;
		}
		idArr.push(data);
		var res=JSON.stringify(idArr);
		return res;
	}
	$("#name").change(function(){
		var name=$("#name").val();
		if(name==""){
			$("#nameMsg").html('<b style="color:red">输入不能为空</b>');
		}else{
			$.ajax({
				type : "GET",
				url : urlPath+"/seal_image",
				data:{
					sealName:name
				},
				dataType : "JSON",
				success : function(retdata) {
					if(retdata){
						$("#nameMsg").html("");
						$("#nameMsg").append('<span class="fa fa-check text-success-dark" aria-hidden="true"></span>');
					}
				},
				error:function (e) {
					var res = $.parseJSON(e.responseText);
					//console.log(res);
					$("#nameMsg").html('<b style="color:red">'+res.message+'</b>');
				}
			});
		}
	});
	function selectDeapartment(){
		var index =top.layer.open({
			title:'选择部门',
			type: 2,
			content: '../../partials/select-section-nolow.html',
			area: ['800px', '500px'],
			btn: ['确定','关闭'],
			maxmin: true,
			yes: function(index){
				//获取单位数据
				var res = window.parent["layui-layer-iframe" + index].getData();
				if(res==null){
					window.parent.layer.alert("请选择部门",{icon:6});
				}else{
					$("#departmentName").val(res.name);
					$("#departmentId").val(res.id);
					top.layer.close(index);
				}
			}
		});
	}
	function selectPeople(){
		var index =top.layer.open({
			title:'选择人员',
			type: 2,
			content: '../seal/select-accredit-people-modalRadio.html?noCache='+new Date().getTime(),
			area: ['800px', '500px'],
			btn: ['确定','关闭'],
			maxmin: true,
			yes: function(index){
				//获取单位数据
				var res = window.parent["layui-layer-iframe" + index].getData();
				if(res==null){
					window.parent.layer.alert("请选择人员",{icon:6});
				}else{
					$("#approvalByName").val(res[0].name);
					$("#approvalBy").val(res[0].id);
					top.layer.close(index);
				}
			}
		});
	}

	$(function() {
		$("#selectImage").change(function(e) {
			var imgBox = e.target;
			uploadImg($('#imgPre'), imgBox)
		});

		function uploadImg(element, tag) {
			var file = tag.files[0];
			if (!/image\/\w+/.test(file.type)) {
				alert("请确保文件为图像类型");
				return false;
			}
			// 设置预览区域为空,预览区域显示
			$('#imgPre').empty();
			$("#imageView").show();

			// 获取上传图片名
			$("#imageName").val(file.name);

			var imgSrc;
			var reader = new FileReader();
			reader.readAsDataURL(file);
			reader.onload = function(e) {
				imgSrc = this.result;
				//获取上传图片base64
				$("#data").val(imgSrc.substr(imgSrc.lastIndexOf("base64,")+7));
				var imgs = document.createElement("img");
				$(imgs).attr("src", imgSrc);
				element.append(imgs);
				$('#imgPre').get(0).src = e.target.result;
				/* 获取高宽*/
				var image = new Image();
				image.src = e.target.result;
				image.onload = function () {
					/*var makeSealSizeStr='宽：'+this.width+'mm;'+'高：'+this.height+'mm';
					$("#imageWidth").val(this.width);
					$("#imageHeight").val(this.height);
					$("#sealSize").val(192);
					$("#makeSealSizeStr").val(makeSealSizeStr);*/
                                                                                  var  width1= Math.floor(this.width/192*25.4);
                                                                                  var  height1= Math.floor(this.height/192*25.4);
                                                                                  var makeSealSizeStr='宽：'+width1+'mm;'+'高：'+height1+'mm';
					  $("#imageWidth").val(this.width);
					  $("#imageHeight").val(this.height);
					  $("#sealSize").val(192);
					  $("#makeSealSizeStr").val(makeSealSizeStr);
				};
			};
		}
	})


	/**
	 * 审批人登记线下申请页面
	 * */
	function offlinePage() {
		$("#approval").hide();
		$("#remarkId").html("审批意见");
		$("#remark").attr("placeholder", "请输入审批意见");
	}

	function sealFormInit(id){
		$.ajax({
			type : "GET",
			url : urlPath+"/seal_image/"+id,
			dataType : "JSON",
			success : function(retdata) {
				if(retdata!=null){
					var data=retdata.data;
					$("#name").val(data.name);
					$("#type").val(data.type);
					$("#sealId").val(data.id);
					$("#departmentName").val(data.department.allName);
					$("#departmentId").val(data.departmentId);
					$("#imageView").show();
					var imageData='data:image/bmp;base64,'+data.previewData;
					$("#imgPre").attr("src",imageData);
					$("#data").val(data.data);
					$("#imageName").val(data.imageName);

					var makeSealSizeStr='宽：'+Math.floor(data.imageWidth/data.sealSize*25.4)+'mm;'+'高：'+Math.floor(data.imageHeight/data.sealSize*25.4 )+'mm';
					$("#imageWidth").val(data.imageWidth);
					$("#imageHeight").val(data.imageHeight);
					$("#sealSize").val(data.sealSize);
					$("#makeSealSizeStr").val(makeSealSizeStr);
					$("#approvalByName").val(retdata.approvalByName);
					$("#approvalBy").val(data.approvalBy);
					$("#remark").val(data.remark);
				}
			}
		});
	}
</script>
</html>